SCQL P2P Deployment Configuration
=================================

SCQL P2P deployment architecture consists of SCQLBroker and SCQLEngine, and the configuration instructions include these two parts.


.. _config_broker_server_options:

SCQLBroker Configuration
------------------------

SCQLBroker uses YAML as configuration file format.

Example configuration for SCQLBroker
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: yaml

  intra_server:
    port: 8080
  inter_server:
    host: 0.0.0.0
    port: 8081
    protocol: https
    cert_file: ${your cert file path}
    key_file: ${your key file path}
  log_level: info
  party_code: alice
  session_expire_time: 24h
  session_expire_check_time: 1m
  party_info_file: "/home/admin/configs/party_info.json"
  private_key_path: "/home/admin/configs/private_key.pem"
  intra_host: http://broker_alice:8080
  engine:
    timeout: 120s
    protocol: http
    content_type: application/json
    uris:
      - for_peer: alice_for_peer:8003
        for_self: alice_for_self:8003
  storage:
    type: mysql
    conn_str: "user_name:pass_word@tcp(127.0.0.1:3306)/db_name?charset=utf8mb4&parseTime=True&loc=Local&interpolateParams=true"
    max_idle_conns: 10
    max_open_conns: 100
    conn_max_idle_time: 2m
    conn_max_lifetime: 5m


Configuration Options of SCQLBroker
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Name                                             | Default   | Description                                                                                                                                                                                                   |
+==================================================+===========+===============================================================================================================================================================================================================+
| intra_server.host                                | 127.0.0.1 | The host where SCQLBroker listens for IntraServer requests, default localhost for safety                                                                                                                      |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| intra_server.port                                | none      | The port on which SCQLBroker listens for IntraServer requests                                                                                                                                                 |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| intra_server.protocol                            | http      | The transfer protocol of IntraServer, supports HTTP/HTTPS                                                                                                                                                     |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| intra_server.cert_file                           | none      | Certificate file path for IntraServer to enable HTTPS, supports crt/pem type                                                                                                                                  |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| intra_server.key_file                            | none      | Private key file path for IntraServer to enable HTTPS, supports key/pem type                                                                                                                                  |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| inter_server.host                                | none      | The host where SCQLBroker listens for InterServer requests                                                                                                                                                    |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| inter_server.port                                | none      | The port on which SCQLBroker listens for InterServer requests                                                                                                                                                 |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| inter_server.protocol                            | http      | The transfer protocol of InterServer, supports HTTP/HTTPS                                                                                                                                                     |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| inter_server.cert_file                           | none      | Certificate file path for InterServer to enable HTTPS, supports crt/pem type                                                                                                                                  |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| inter_server.key_file                            | none      | Private key file path for InterServer to enable HTTPS, supports key/pem type                                                                                                                                  |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| inter_timeout                                    | 5s        | Timeout for requesting InterServe                                                                                                                                                                             |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| log_level                                        | info      | The type and severity of a logged event                                                                                                                                                                       |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| party_code                                       | none      | Unique identifier used to identify the party                                                                                                                                                                  |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| party_info_file                                  | none      | File path that stores information of each party, including party code, public key and InterServer's URL                                                                                                       |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| private_key_path                                 | none      | Private key file path for party_code, which will be used to sign requests to other SCQLBrokers                                                                                                                |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| private_key_data                                 | none      | The base64 encoded PEM-encoded private key for party_code, only valid if private_key_path is empty                                                                                                            |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| intra_host                                       | none      | The callback URL for the local SCQLEngine to notify SCQLBroker                                                                                                                                                |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| inter_host                                       | none      | The InterServer's URL                                                                                                                                                                                         |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.timeout                                   | none      | Timeout for SCQLBroker to send message to SCQLEngine                                                                                                                                                          |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.mode                                      | none      | Engine client mode, supports GRPC and HTTP/HTTPS. In GRPC mode, tls_cfg is required. In HTTP/HTTPS mode, protocol and content_type are necessary                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.tls_cfg.mode                              | none      | Tls mode for engine client: *NOTLS*/TLS/MTLS.                                                                                                                                                                 |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.tls_cfg.cert                              | none      | The path to the file containing informations about the certificate for engine client                                                                                                                          |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.tls_cfg.key                               | none      | The path to the file containing informations about the private key for engine client                                                                                                                          |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.tls_cfg.cacert                            | none      | The path to the file containing informations about the ca certificate for engine client                                                                                                                       |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.protocol                                  | http      | The transfer protocol of SCQLEngine, support http/https                                                                                                                                                       |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.content_type                              | none      | The original media type in post body from SCQLBroker to SCQLEngine                                                                                                                                            |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.scheduler                                 | naive     | The Scheduler to sechedule SCQLEngine, supported schedulers: kuscia/naive                                                                                                                                     |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.uris                                      | none      | The URIs for local SCQLEngines, which using **for_peer** to serve peer engines and **for_self** to serve the SCQLBroker,if **for_self** is empty, **for_peer** is used instead, valid when scheduler is naive |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.endpoint                 | none      | Grpc endpoint for kuscia scheduler to connect to the kuscia server                                                                                                                                            |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.tls_mode                 | none      | Tls mode for kuscia scheduler, supported mode: NOTLS/TLS/MTLS, token is need when mode is TLS or MTLS                                                                                                         |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.cert                     | none      | Certificate for kuscia scheduler                                                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.key                      | none      | Private key for kuscia scheduler                                                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.cacert                   | none      | CA certificate for kuscia scheduler                                                                                                                                                                           |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.token                    | none      | Token for kuscia scheduler, needed when tls_mode is TLS or MTLS                                                                                                                                               |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.max_poll_times           | 20        | The maximum poll times for kuscia scheduler to poll whether kuscia job is running                                                                                                                             |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.poll_interval            | 1s        | The time interval between two consecutive polls of the kuscia scheduler, default 1 second                                                                                                                     |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.max_wait_time            | 1m        | The maximum timeout that the kuscia scheduler will wait for a job to be scheduled, default 1 miniute                                                                                                          |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| engine.kuscia_scheduler.keep_job_alive_for_debug | false     | Whether keep job alive for debug perpose, by default, the job is terminated when it completes                                                                                                                 |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| security_compromise.reveal_group_mark            | false     | Whether to reveal group_mark directly for group by                                                                                                                                                            |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|| security_compromise.group_by_threshold          || 4        || Minimum amount of data within a group that will be retained(effective only for the group by syntax, and not for distinct, etc.)                                                                              |
||                                                 ||          || **Warning**: This is a parameter related to the project. Modification will not impact existing projects.                                                                                                     |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.type                                   | file      | The discovery type for finding peers, support file/consul/kuscia                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.file                                   | none      | The path to the file containing informations about other parties                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.consul.address                         | none      | The address for consul discovery to connect to the consul server                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.consul.token                           | none      | The ACL token that should be presented when registering the service(party info) if ACLs are enabled.                                                                                                          |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.conusl.tls.mode                        | none      | Tls mode for consul discovery, supported mode: *NOTLS*/TLS/MTLS                                                                                                                                               |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.conusl.tls.cert                        | none      | The path to the file containing informations about the certificate for consul discovery                                                                                                                       |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.conusl.tls.key                         | none      | The path to the file containing informations about the private key for consul discovery                                                                                                                       |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.conusl.tls.cacert                      | none      | The path to the file containing informations about the ca certificate for consul discovery                                                                                                                    |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.conusl.datacenter                      | none      | The datacenter specifies a logical grouping of nodes                                                                                                                                                          |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.kuscia.endpoint                        | none      | Grpc endpoint for kuscia discovery to connect to the kuscia server                                                                                                                                            |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.kuscia.tls_mode                        | none      | Tls mode for kuscia discovery, supported mode: *NOTLS*/TLS/MTLS, token is need when mode is TLS or MTLS                                                                                                       |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.kuscia.cert                            | none      | Certificate for kuscia discovery                                                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.kuscia.key                             | none      | Private key for kuscia discovery                                                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.kuscia.cacert                          | none      | CA certificate for kuscia discovery                                                                                                                                                                           |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery.kuscia.token                           | none      | Token for kuscia discovery, needed when tls_mode is TLS or MTLS                                                                                                                                               |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| storage.type                                     | none      | Database kind in SCQLBroker, supports MYSQL/SQLite3, MYSQL is recommended, SQLite3 may have problems with concurrency                                                                                         |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| storage.conn_str                                 | none      | Used to connect to a database                                                                                                                                                                                 |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| storage.max_idle_conns                           | 1         | Maximum number of connections in idle connection pool                                                                                                                                                         |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| storage.max_open_conns                           | 1         | Maximum number of open connections to the database                                                                                                                                                            |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| storage.conn_max_idle_time                       | -1s       | Maximum amount of time a connection may be idle                                                                                                                                                               |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| storage.conn_max_lifetime                        | -1s       | Maximum amount of time a connection may be reused                                                                                                                                                             |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| session_expire_time                              | 24h       | Maximum lifespan of a job                                                                                                                                                                                     |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| session_expire_check_time                        | 1m        | The interval checking whether session is timeout                                                                                                                                                              |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| persist_session                                  | true      | Whether persist session to storage to support cluster mode                                                                                                                                                    |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| exchange_job_info_retry_times                    | 3         | Retry times when exchange job infomation between parties                                                                                                                                                      |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| exchange_job_info_retry_interval                 | 200ms     | The retry interval when exchange job infomation between parties, default 200 millisecond                                                                                                                      |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|| batched                                         || false    || Whether to run in streaming mode to reduce memory usage.                                                                                                                                                     |
||                                                 ||          || **Warning**: Experimental feature; do not use in production.                                                                                                                                                 |
+--------------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


Config for ServerConfig
^^^^^^^^^^^^^^^^^^^^^^^
SCQLBroker accept intra-domain requests through IntraServer, while accept requests between different SCQLBrokers through InterServer.

IntraServer is recommended to use localhost host or LAN address to avoid external attacks, while InterServer is recommended to enable HTTPS to improve security.

.. _broker-tls:

Please refer to the following configuration to enable HTTPS for InterServer: (similar to IntraServer)

.. code-block:: yaml

  inter_server:
    host: 0.0.0.0
    port: 8081
    protocol: https
    cert_file: ${your cert file path}
    key_file: ${your key file path}

.. note::

  Self-signed CA files may not be trusted by default, please refer to `Trouble shooting <https://github.com/secretflow/scql/tree/main/test-tools#trouble-shooting>`_ for help.

  Please change the endpoints in **party_info.json** from http to https.

  We have enabled HTTPS in the `p2p examples <https://github.com/secretflow/scql/blob/main/examples/p2p-tutorial/README.md>`_, and the initialization process of related configurations may provide some help.

For SCQLEngine to work with SSL, please refer :ref:`Config for SSL in SCQLEngine <scqlengine-tls>`.

Reused Config
^^^^^^^^^^^^^

For more about SecurityCompromise, see :ref:`Config for SecurityCompromise <config_security_compromise_options>`

For more about Storage, see :ref:`Config for storage <config_storage_options>`



.. include:: /reference/engine-config.rst
